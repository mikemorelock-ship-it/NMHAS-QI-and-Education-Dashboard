# EMS Dashboard - Improvements Backlog

Ranked by importance/risk. Update status as items are completed.

## Tier 1: Security Risks (fix before production exposure)
- [x] 1. **Fix hardcoded secrets** - Removed fallback JWT secret from source code, removed dead `ADMIN_PASSWORD_HASH` from `.env`. Centralized secret via `src/lib/env.ts` which rejects the old hardcoded fallback and warns on weak secrets.
- [x] 2. **Add API rate limiting** - Added `src/lib/rate-limit.ts` using `LoginAttempt` table. 5 failures per 15 minutes triggers rate limit; 10 failures per hour triggers 30-minute account lockout. Applied to both admin and field training login endpoints.
- [x] 3. **Validate environment variables at startup** - `src/lib/env.ts` validates `DATABASE_URL` and `JWT_SECRET` at import time; missing vars throw immediately, weak secrets warn.
- [x] 4. **Add Next.js security headers** - Added CSP, HSTS, X-Frame-Options, X-Content-Type-Options, Referrer-Policy, and Permissions-Policy via `next.config.ts` headers. CSP includes `ws:`/`wss:` for dev HMR.

- [x] 5. **Account lockout after failed login attempts** - Integrated with rate limiting (#2). 10 failed attempts in 1 hour triggers 30-minute lockout. Uses existing `LoginAttempt` table — no schema changes needed. Clear error messages distinguish rate limiting from lockout.
- [x] 6. **Session invalidation on password change / account disable** - Added `sessionVersion` field to AdminUser, Fto, and Trainee models. Version is embedded in JWT and checked against DB on every `verifySession`/`verifyFtSession` call. Incremented on password/PIN change, account disable, and role change. Current user gets a re-issued session after own password change.
- [x] 7. **Enforce password complexity requirements** - Added `src/lib/password-validation.ts` with rules: min 8 chars, uppercase, lowercase, number, special character. Applied via Zod refinement on registration, admin user creation, and password change forms. Human-readable `PASSWORD_REQUIREMENTS` constant for UI messages.
- [x] 8. **Log failed login attempts and permission denials** - Added `LoginAttempt` model with portal, identifier, success, reason, IP, and user agent. All login paths (admin + field training) log attempts via `logLoginAttempt()`. Indexed for efficient querying by identifier, portal, and success status.
- [x] 9. **Add CSRF protection** - Added `src/lib/csrf.ts` with Origin header validation against allowed origins. Applied `validateCsrf()` to login (admin + field training), registration, and CSV upload server actions. Supports `NEXT_PUBLIC_SITE_URL` for production origin allowlisting.
- [x] 10. **Enforce HTTPS and configure CORS** - HSTS header enforces HTTPS in browsers (from #4). Added explicit CORS configuration in middleware: `Access-Control-Allow-Origin` whitelist, OPTIONS preflight handling for `/api/*` routes, 24h preflight cache. Production origins configured via `NEXT_PUBLIC_SITE_URL`. HTTP→HTTPS redirect deferred to deployment layer (reverse proxy).
- [x] 11. **Validate JWT in middleware** - Middleware now calls `jwtVerify()` to validate signature and expiration. Invalid/expired tokens are rejected and cookies cleared to prevent redirect loops.
- [x] 12. **Add file upload validation** - Client-side: 5MB file size limit, `.csv/.tsv/.txt` extension whitelist, 10,000 row maximum. Server-side: `importUploadedData()` enforces 10,000 row limit, permission check via `requireAdmin("upload_batch_data")`, and CSRF validation. Chunked transaction processing (500 rows) prevents DB overload.
- [x] 13. **Strengthen FTO/trainee PIN requirements** - Increased minimum PIN length from 4 to 6 digits (max 8). Updated server validation, client-side forms, login page `maxLength`/placeholder, and seed data (PIN now `123456`). Combined with rate limiting (#2/#5), brute-force is infeasible.
- [x] 14. **Add dependency vulnerability scanning** - Added `security:audit` and `security:audit:all` npm scripts. Current vulnerabilities are in Prisma dev tooling dependencies (moderate, not runtime).
- [x] 15. **Add `.env` to `.gitignore`** - `.env*` already in `.gitignore`. Created `.env.example` template with placeholder values for documentation.
- [x] 16. **Remove hardcoded fallback DB path** - Removed `C:/Users/mikem/.local/...` fallback from `src/lib/db.ts`. Now throws immediately if `DATABASE_URL` is missing, with a clear error message pointing to `.env.example`.
- [x] 17. **Sanitize error messages** - Verified all server actions and API routes return generic error messages to clients; Prisma details only in server-side `console.error`. Added `src/lib/safe-error.ts` utility for consistent error handling in future actions.
- [x] 18. **Add idle session timeout** - Added `src/components/IdleTimeout.tsx` with 30-minute inactivity detection. Shows warning dialog with 60-second countdown before auto-logout. Cross-tab sync via localStorage. Throttled activity tracking. Applied to all authenticated layouts (admin, public, field training).
- [x] 19. **Rate limit data API routes** - Added in-memory per-IP rate limiting in middleware: 60 requests/minute for all `/api/*` routes. Returns 429 with `Retry-After` header when exceeded. Auto-cleanup of expired rate buckets every 2 minutes.
- [x] 20. **Add concurrent session awareness** - Added `lastLoginAt`/`lastLoginIp` fields to User model. Login action records IP and timestamp. Added `logoutOtherDevicesAction()` that increments `sessionVersion` to invalidate all other sessions while re-issuing the current one. Audit logged.

## Tier 2: Reliability (prevents data loss / crashes)
- [x] 21. **Add React error boundaries** - Created `error.tsx` boundary components for all three portal layouts (admin, public dashboard, field training) plus a `global-error.tsx` fallback at the app root. Each boundary catches render errors in its subtree, shows a friendly error message with recovery options ("Try Again" and navigation back to dashboard), and logs the error client-side. Global error boundary uses minimal inline styles (no component library) to avoid cascading failures.
- [x] 22. **Add a test suite** - Added Vitest with V8 coverage. 228 tests across 8 test files covering all pure-function library modules: permissions (48 tests), password-validation (19), safe-error (8), api-response (11), pagination (28), utils (41), aggregation (30), and spc (43). Coverage: 95% statements, 89% branches, 95% functions, 95% lines. Tests run via `npm test`, watch mode via `npm run test:watch`, coverage via `npm run test:coverage`.
- [x] 23. **Add request/audit logging** - Audited all 101 mutation functions across 15 server action files. Found 99% already had audit logging. Fixed 2 gaps: added missing `prisma.auditLog.create()` call to `reorderDriverNodes` in `driver-diagrams.ts`, and fixed lowercase `"update"` → `"UPDATE"` action name in `metric-associations.ts` for consistency. All mutations now log action, entity, entityId, details, actorId, and actorType.
- [x] 24. **Improve API response consistency** - Audited all 11 API routes. Found responses were already 95% consistent: all use `try/catch` with `console.error` + `{ error: "message" }` JSON shape with proper HTTP status codes (400, 404, 500). Fixed the one gap: added `try/catch` to the logout endpoint. Created `src/lib/api-response.ts` with reusable helpers (`apiError`, `apiNotFound`, `apiBadRequest`, `apiServerError`) for future API routes.

## Tier 3: Scalability (will break as usage grows)
- [x] 25. **Add pagination** - Created reusable `src/lib/pagination.ts` (parsePagination, paginatedQuery, buildPaginationUrl) and `src/components/PaginationControls.tsx` (Link-based, preserves search params, page number navigation). Applied server-side pagination to Data Entry (50/page, was 1000 hardcoded) and DORs (50/page, was 100 hardcoded). Pattern is ready for any admin page: just import, parse params, add skip/take, and render PaginationControls.
- [x] 26. **Optimize potential N+1 queries** - Rewrote 5 dashboard API routes to use bulk `WHERE IN` queries + in-memory JS partitioning instead of per-item loops. Changes: `/api/dashboard/overview` (2*N queries → 1), `/api/dashboard/[slug]` (3*N → 2), `/api/dashboard/global-metric/[slug]` (3 N+1 patterns → 3 bulk), `/api/dashboard/metric/[dept]/[metric]` (2 N+1 → 2 bulk), `/api/dashboard/division/[div]/metric/[metric]` (2 N+1 → 2 bulk). `/api/dashboard/route.ts` was already optimized. Pattern: fetch all entries with `metricDefinitionId: { in: ids }`, index by grouping key in a Map, then build results in-memory.
- [x] 27. **Implement role-based access control** - Individual admin accounts with 3 role tiers (Super Admin, Data Entry, Training Manager), enforced FTO role hierarchy (fto/supervisor/manager), permission guards on all server actions, page-level checks, registration/approval flow, admin user management page.
- [x] 28. **Consolidate FTO and trainee portals** - Merged into unified `/fieldtraining` portal with single login, discriminated union session (`ft-session` cookie), role-based dashboard/navbar, and shared route group. Old `/fto` and `/trainee` portals removed.
- [x] 29. **Unified login portal with role-based routing** - Single `User` model replaces `AdminUser`/`Fto`/`Trainee`. Six unified roles: admin, manager, data_entry, supervisor, fto, trainee. Single login page at `/login` with email+password for all. Role-based post-login redirect: admin/manager/data_entry → `/`, supervisor/fto/trainee → `/fieldtraining`. Dashboard requires login. Single `session` cookie, single permissions system. Training Manager role removed (absorbed into Manager). Supervisors promoted to manage training assignments and phase signoffs.

## Tier 4: Core Functionality Gaps
- [x] 30. **Add Departments filter to Field Training Dashboard** - Cascading division/FTO/trainee/phase filters on the public field training page with clear-all button.
- [ ] 31. **Add data export (CSV/Excel/PDF)** - Stakeholders expect to pull data out for reporting.
- [x] 32. **Add Quality Improvement Campaigns** - Added Campaign and ActionItem models. Campaigns are the primary view on the QI Tools page with status, owner, timeline, goals, and linked driver diagrams/PDSA cycles. Campaign detail page shows PDSA pipeline visualization (Plan/Do/Study/Act/Done columns), driver diagrams grid, and action items list. Admin pages for campaign CRUD (`/admin/campaigns`, `/admin/campaigns/[id]`) and action items management (`/admin/action-items`) with filters by status/priority/campaign. Action items track corrective actions with priority, assignee, due date, and links to campaigns/PDSA cycles. Standalone diagrams and cycles appear in a separate "Other QI Activities" section.
- [ ] 33. **Connect QI tools to metrics with chart annotations** - Associate campaigns, driver diagrams, and PDSA cycles with one or more metrics. Display PDSA cycle "Do" start dates as vertical annotation lines on SPC control charts and continuous trend charts so teams can visually monitor performance changes resulting from interventions. The QI module is currently disconnected from the metrics it's meant to improve.
- [ ] 34. **Add bulk operations** - Manual one-by-one entry doesn't scale for real operational use.
- [ ] 35. **Add metric archival workflow** - No way to retire old metrics without deleting historical data.
- [x] 36. **Email notifications** - Added DOR submission email notifications to supervisors and managers via Nodemailer SMTP. Emails include full DOR summary with trainee/FTO names, date, phase, overall rating, category ratings, narrative, and recommendation action. Alert banners highlight poor scores (≤3), NRT flags, and REM flags. "View DOR in Portal" CTA button links directly to the DOR. Fire-and-forget pattern ensures email failures never block DOR submission. Graceful degradation when SMTP is not configured (dev environments). Phase transition and threshold alert emails deferred to future iteration.
- [ ] 37. **Click-through DOR detail from Team DORs** - Supervisors reviewing Team DORs should be able to click into the full DOR to review ratings, narrative, and add supervisor notes.
- [x] 38. **DOR attestation status tracking** - Added DOR acknowledgment gate: when an FTO selects a trainee with unacknowledged submitted DORs, the New DOR form blocks submission and displays a warning with the count of pending acknowledgments. Enforces the feedback loop — trainees must review evaluations before receiving new ones. Unacknowledged counts fetched via efficient `groupBy` query.
- [ ] 39. **Department-scoped field training access** - FTOs, supervisors, and managers only see field training data for their assigned departments. Department assignments are configured by admins.
- [ ] 59. **Integrated vertical QI workflow with preset modes** - Redesign QI tools from isolated data entry forms into a connected workflow with three user-selectable modes. The data model stays the same across all modes (Campaign → Driver Diagram → Change Ideas → PDSA Cycles); only the UI flow differs. **Guided (Campaign Wizard)**: Linear stepper following the IHI Model for Improvement — define aim, build driver diagram, identify change ideas, plan PDSA cycles. Each step validates and prompts the next. Includes embedded QI coaching based on IHI best practices at each step: (1) Aim Statement — prompts for SMART criteria with examples ("A strong aim includes a specific target and timeline"), (2) Measures — guides users to define outcome, process, and balancing measures with explanations of each type, (3) Driver Diagram — coaches primary→secondary driver hierarchy with tips on making drivers actionable, (4) Change Ideas — prompts to think small and testable ("What's the smallest version you could test tomorrow?"), (5) PDSA Cycle — walks through each phase with guiding questions (Plan: "What do you predict?", Do: "Document the unexpected", Study: "Compare to prediction", Act: "Adopt, adapt, or abandon?"), (6) Iteration — after cycle completion, prompts "Most improvements require 3-5 cycles. What will you test differently?" Coaching appears as contextual help panels, inline tips, and expandable "Learn more" sections — present but not blocking. Auto-links everything. Best for new QI practitioners and formal projects. **Flexible (Connected Canvas)**: Start from any entity. System suggests links for orphaned items ("This PDSA cycle isn't connected to a campaign — link one?"). Dashboard shows completeness indicators. Best for experienced QI leads. **Quick Capture (Standalone)**: Create any entity independently with no prompts — essentially today's behavior but with an optional "Connect to..." action. Best for rapid tests and ad-hoc PDSA cycles. All modes include: campaign-level strategy map, breadcrumb navigation, progressive development, gap indicators, and the ability to retroactively connect standalone items. The tool should help users develop their QI strategy, not just display it.

- [x] 60. **Coaching activities foundation** - Auto-assigned remedial coaching when trainees receive poor DOR scores (≤3) in evaluation categories. Schema: `CoachingActivity` (title, category, type, content, difficulty, estimated time) and `TraineeCoachingAssignment` (status tracking, progress, response/score). Coaching engine auto-assigns activities after DOR submission (fire-and-forget). Trainee coaching dashboard at `/fieldtraining/coaching` shows assigned/in-progress/completed activities grouped by status. Reading and reflection activity types are functional; quiz and scenario types are placeholder for future AI integration. 18 seed activities covering key EMS evaluation categories. Coaching stats card added to trainee dashboard. Nav link with activity count badge.
- [x] 61. **Trainee snapshot dashboard** - Shareable, point-in-time trainee progress reports accessible via unique token URL (no auth required). Snapshot builder aggregates: profile, DOR summary (avg rating, trends, category averages, best/worst 3, NRT/REM counts), phase progress, skill completion by category, coaching activity stats. Beautiful printable report page with NMH branding, teal gradient header, stats grid, strengths/weaknesses cards, rating trend chart, category performance bars, phase timeline, and print-friendly CSS. Admin page at `/admin/field-training/snapshots` with multi-select trainee table for bulk generation. Copy link, deactivate, and manage snapshot history. Reports are frozen at creation time.

## Tier 5: UX & Polish
- [ ] 40. **Searchable dropdown menus** - Add typeahead/search filtering to select fields (e.g., trainee, FTO, metric, department pickers). Lists will become unwieldy as the number of records grows.
- [x] 41. **Remove date and time from main page** - Removed unnecessary date/time clutter from main dashboard.
- [ ] 42. **Consolidate admin sidebar navigation** - Group related menu items under expandable sections (e.g., a "QI/QA" group containing Metrics, Data Entry, Upload, Driver Diagrams, PDSA Cycles, and Scorecards). Reduces sidebar clutter and makes navigation easier as the admin panel grows.
- [ ] 43. **Add skeleton loaders everywhere** - Pages with no loading state feel broken on slow connections.
- [ ] 44. **Improve accessibility (ARIA labels, color-only indicators)** - Compliance and usability.
- [ ] 45. **Improve date range picker UX** - Custom ranges are error-prone without a proper calendar component.
- [x] 46. **Trainee progress visualization** - Addressed by Trainee Snapshots (#61). Snapshot reports combine DOR trends, phase completion, skill tracking, coaching progress, and strengths/weaknesses into a single shareable view. Trainee dashboard also shows coaching stats alongside existing DOR/skill/phase counts.
- [ ] 47. **Driver diagram visual editor** - Form-based editing works but is clunky for a diagram tool.

## Tier 6: Future / Strategic
- [ ] 48. **Scheduled/automated reports** - Valuable once the dashboard is stable and adopted.
- [ ] 49. **PWA support** - Important for FTOs in the field.
- [ ] 50. **SSO/SAML integration** - Enterprise auth for deployment.
- [ ] 51. **API documentation (OpenAPI)** - Needed when external systems integrate.
- [ ] 52. **Advanced charting (Pareto, fuller SPC)** - Nice to have once base charting is reliable.
- [ ] 53. **Mobile-responsive UI / mobile app** - Ensure full mobile functionality across the dashboard and portals. Consider a dedicated mobile app or PWA for FTOs and trainees doing field work on phones/tablets.
- [ ] 54. **Mini learning management system** - Built-in practice modules for trainees to drill ECG recognition, medication doses, protocol recall, and other clinical knowledge. Trackable scores and progress tied to trainee profiles.
- [ ] 55. **Stricter ESLint rules** - Code quality guardrail, low urgency.
- [ ] 56. **Interactive root cause analysis diagram** - Visual, interactive tool for conducting and documenting root cause analyses (e.g., fishbone/Ishikawa diagrams, 5 Whys). Integrates with existing QI tools.
- [ ] 57. **Interactive just culture algorithm** - Step-by-step interactive decision tool implementing the just culture algorithm for evaluating behaviors and determining appropriate responses. Guides supervisors through the algorithm with documentation and audit trail.
- [ ] 58. **Lessons Learned Log** - Searchable knowledge base built from completed PDSA cycles and RCA investigations. Captures key findings, what worked, what didn't, and recommendations. Tagged and filterable by topic, department, and date range so teams can learn from past QI work and avoid repeating mistakes.
